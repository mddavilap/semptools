---
title: "Using semptools for an Mplus output file"
author: "Shu Fai Cheung & Mark Hok Chio Lai"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{demo_mplus}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width  =  8,
  fig.height =  6,
  fig.align = "center"
)
```

```{r setup, echo = FALSE}
```

# Introduction

The semptools package contains functions that *post-process* an output from 
`semPlot::semPaths`, to help users to customize the appearance of the graphs 
generated by `semPlot::semPaths`. For the introduction to functions for doing 
very specific tasks, such as moving the parameter estimate of a path or rotating
the residual of a variable, please refer to [Quick Start Guide](01_quick_start.html).
The present guide focuses on postprocessing an Mplus output (usually with a .out extension).

# Example

This example is taken from the [semPlot documentation](http://sachaepskamp.com/semPlot/examples?page_id=489#Mplus). It is a multiple-indicator multiple cause (MIMIC) model with two latent variables measured by six indicators and three covariates. 

```{r ex5.8}
library(semPlot)
# Specify mplus output file from their user guide
download.file("http://www.statmodel.com/usersguide/chap5/ex5.8.out", 
              outfile <- tempfile(fileext = ".out"))
p_mplus <- semPaths(
  outfile,
  intercepts = FALSE,
  whatLabels = "est",
  sizeMan = 7, 
  node.width = 1,
  edge.label.cex = 1,
  style = "ram"
)
```

## Rotate the residuals of selected variables: `rotate_resid()`

Assume we want to rotate the uniqueness of `Y1` to the bottom-left corner, and the uniqueness of `Y6` to the bottom-right corner. 

```{r p_mplus2}
library(semptools)
my_rotate_resid_list <- list(list(node = "Y1", rotate = -135),
                             list(node = "Y6", rotate =  135))
 
p_mplus2 <- rotate_resid(p_mplus, my_rotate_resid_list)
plot(p_mplus2)
```

## Set the curve attributes of selected arrows: `set_curve()`

Let's say we want to change the covariance of the path between `F1` and `F2` so that it's bending downwards. We can use the `set_curve()` function. But first, we need to know how the path is stored. The code below extract information from the `qgraph` object (we may need to add a function to make this easier). 

```{r}
p_mplus2_nodes_labels <- p_mplus2$graphAttributes$Nodes$labels
cbind(from = p_mplus2_nodes_labels[p_mplus2$Edgelist$from], 
      to = p_mplus2_nodes_labels[p_mplus2$Edgelist$to])
```

For some reason this path was shown twice. We need the first of them, in this case `from` should be set to `F2` and `to` should be set to `F1`.

```{r p_mplus3}
my_curve_list <- list(list(from = "F2", to = "F1", new_curve = 1)) 
p_mplus3 <- set_curve(p_mplus2, my_curve_list)
plot(p_mplus3)
```

# Limitations

- Currently, functions that require an `lavaan` object as input, such as `mark_se()` and `mark_sig()`, do not support Mplus outputs.  

